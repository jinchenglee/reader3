<!-- Shared Chat Sidebar Component -->
<!-- CSS for Chat -->
<style>
    :root {
        --chat-bg: #E7EEF6;
        --primary-color: #3498db;
    }

    #chat-sidebar {
        /* Removed fixed width and sidebar positioning */
        display: flex;
        flex-direction: column;
        flex: 1;
        height: 100%;
        background: #fff;
    }

    #chat-sidebar.collapsed {
        /* No longer used */
    }

    /* Resize Handle Removed */

    .chat-header {
        padding: 10px 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        color: #495057;
        font-size: 0.95em;
        flex-shrink: 0;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background: var(--chat-bg);
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .message {
        max-width: 85%;
        padding: 10px 14px;
        border-radius: 12px;
        line-height: 1.4;
        font-size: 0.95em;
        word-wrap: break-word;
    }

    .msg-user {
        align-self: flex-end;
        background: #3498db;
        color: white;
        border-bottom-right-radius: 2px;
    }

    .msg-ai {
        align-self: flex-start;
        background: white;
        color: #333;
        border-bottom-left-radius: 2px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .msg-system {
        align-self: center;
        background: rgba(0, 0, 0, 0.05);
        color: #666;
        font-size: 0.8em;
    }

    .chat-input-area {
        padding: 15px;
        background: white;
        border-top: 1px solid #e9ecef;
        flex-shrink: 0;
    }

    #chat-context {
        font-size: 0.8em;
        color: #666;
        margin-bottom: 8px;
        padding: 8px;
        background: #f8f9fa;
        border-left: 3px solid #3498db;
        border-radius: 4px;
        display: none;
        max-height: 100px;
        overflow-y: auto;
        white-space: pre-wrap;
    }

    .chat-controls {
        display: flex;
        gap: 8px;
    }

    #chat-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        resize: none;
        height: 40px;
        font-family: inherit;
    }

    #chat-input:focus {
        outline: none;
        border-color: #3498db;
    }

    button.btn-send {
        background: #3498db;
        color: white;
        border: none;
        padding: 0 15px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
    }

    button.btn-send:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* Settings Modal */
    #settings-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        /* Ensure on top */
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        width: 400px;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .form-group {
        margin-bottom: 15px;
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
    }

    input,
    select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    .spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        width: 12px;
        height: 12px;
        animation: spin 1s linear infinite;
        display: inline-block;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<!-- Sidebar HTML -->
<div id="chat-sidebar">
    <!-- Resize handle removed -->
    <div class="chat-header">
        <span>AI Assistant</span>
        <div style="display: flex; gap: 5px; align-items: center;">
            <button class="btn-icon" id="clear-chat-btn" title="Clear chat history"
                style="background:none; border:none; cursor:pointer; font-size:0.85em; color:#999;">üóëÔ∏è Clear</button>
            <button class="btn-icon" id="settings-btn" style="background:none; border:none; cursor:pointer;">‚öôÔ∏è</button>
        </div>
    </div>

    <div class="chat-messages" id="chat-messages">
        <div class="message msg-system">
            Select text to ask about it, or just type a question.
        </div>
    </div>

    <div class="chat-input-area">
        <div id="chat-context">
            <span id="chat-context-text"></span>
            <button id="clear-context-btn" title="Clear selection"
                style="float:right; background:none; border:none; cursor:pointer; color:#999; font-size:1.1em; padding:0 4px; line-height:1;">√ó</button>
        </div>
        <div class="chat-controls">
            <textarea id="chat-input" placeholder="Ask a question..." rows="1"></textarea>
            <button class="btn-send" id="send-btn">Send</button>
        </div>
    </div>
</div>

<!-- Settings Modal HTML -->
<div id="settings-modal">
    <div class="modal-content">
        <h3 style="margin-top: 0;">AI Settings</h3>

        <div class="form-group">
            <label>Provider</label>
            <select id="api-provider">
                <option value="openai">OpenAI</option>
                <option value="anthropic">Anthropic (Claude)</option>
                <option value="custom">Custom Server</option>
            </select>
        </div>

        <div class="form-group">
            <label>API Key</label>
            <input type="password" id="api-key" placeholder="sk-...">
        </div>

        <div class="form-group" id="base-url-group" style="display:none;">
            <label>Base URL</label>
            <input type="text" id="base-url" placeholder="http://localhost:1234/v1/chat/completions">
        </div>

        <div class="form-group">
            <label>Model Name</label>
            <input type="text" id="model-name" placeholder="gpt-4o" value="gpt-4o">
        </div>

        <div class="modal-actions">
            <button id="cancel-settings"
                style="padding: 8px 15px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button id="save-settings"
                style="padding: 8px 15px; border: none; background: #3498db; color: white; border-radius: 4px; cursor: pointer;">Save</button>
        </div>
    </div>
</div>

<!-- Chat Logic Script -->
<script>
    // --- Chat Logic ---
    const chatSidebar = document.getElementById('chat-sidebar');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const contextDiv = document.getElementById('chat-context');

    let currentSelectedContext = "";
    let chatHistory = []; // In-memory list of {role, content}

    // Exposed function for external scripts to update context
    window.updateChatContext = function (text) {
        currentSelectedContext = text;
        const contextTextSpan = document.getElementById('chat-context-text');
        if (text) {
            contextDiv.style.display = 'block';
            contextTextSpan.textContent = `Selected: "${text.substring(0, 100)}..."`;
        } else {
            contextDiv.style.display = 'none';
            contextTextSpan.textContent = '';
        }
    };

    // Clear context button
    document.getElementById('clear-context-btn').addEventListener('click', function () {
        currentSelectedContext = "";
        contextDiv.style.display = 'none';
        document.getElementById('chat-context-text').textContent = '';
    });

    // --- Chat History Persistence ---
    function getBookId() {
        return window.bookId || '';
    }

    async function loadChatHistory() {
        const bid = getBookId();
        if (!bid) return;
        try {
            const resp = await fetch(`/api/chat-history/${bid}`);
            if (!resp.ok) return;
            chatHistory = await resp.json();
            // Render existing messages
            chatHistory.forEach(msg => {
                appendMessageToUI(msg.role, msg.content);
            });
        } catch (e) {
            console.error('Failed to load chat history:', e);
        }
    }

    async function saveChatMessage(role, content) {
        const bid = getBookId();
        if (!bid) return;
        try {
            await fetch(`/api/chat-history/${bid}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role, content })
            });
        } catch (e) {
            console.error('Failed to save chat message:', e);
        }
    }

    async function clearChatHistoryOnServer() {
        const bid = getBookId();
        if (!bid) return;
        try {
            await fetch(`/api/chat-history/${bid}`, { method: 'DELETE' });
        } catch (e) {
            console.error('Failed to clear chat history:', e);
        }
    }

    function appendMessageToUI(role, text) {
        const div = document.createElement('div');
        div.className = `message msg-${role}`;
        div.textContent = text;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return div;
    }
    function appendMessage(role, text) {
        return appendMessageToUI(role, text);
    }

    async function sendMessage() {
        const text = chatInput.value.trim();
        if (!text && !currentSelectedContext) return;

        const finalPrompt = text || "Explain this";
        const contextSnapshot = currentSelectedContext;

        appendMessage('user', finalPrompt);
        chatInput.value = "";

        // Save user message to history
        const userContent = contextSnapshot
            ? `Context:\n"""${contextSnapshot}"""\n\nQuestion: ${finalPrompt}`
            : finalPrompt;
        chatHistory.push({ role: 'user', content: finalPrompt });
        saveChatMessage('user', finalPrompt);

        const loadingMsg = appendMessage('ai', 'Thinking...');
        loadingMsg.innerHTML = '<div class="spinner"></div>';

        const provider = localStorage.getItem('ai_provider') || 'openai';
        const apiKey = localStorage.getItem('ai_api_key') || '';
        const baseUrl = localStorage.getItem('ai_base_url') || '';
        const model = localStorage.getItem('ai_model') || 'gpt-4o';

        if (!apiKey && provider !== 'custom') {
            loadingMsg.textContent = "Error: Please configure API Key in settings ‚öôÔ∏è";
            return;
        }

        const messages = [
            { role: "system", content: "You are a helpful reading assistant. Answer questions about the user's selected text." }
        ];

        if (contextSnapshot) {
            messages.push({ role: "user", content: `Context:\n"""${contextSnapshot}"""\n\nQuestion: ${finalPrompt}` });
        } else {
            messages.push({ role: "user", content: finalPrompt });
        }

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ provider, apiKey, baseUrl, model, messages })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.detail || "Request failed");

            let answer = "";
            if (provider === 'anthropic') {
                answer = data.content[0].text;
            } else {
                answer = data.choices[0].message.content;
            }
            loadingMsg.textContent = answer;

            // Save AI response to history
            chatHistory.push({ role: 'ai', content: answer });
            saveChatMessage('ai', answer);

        } catch (err) {
            loadingMsg.textContent = "Error: " + err.message;
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // --- Settings Modal Logic ---
    const modal = document.getElementById('settings-modal');
    const settingsBtn = document.getElementById('settings-btn');
    const saveSettingsBtn = document.getElementById('save-settings');
    const cancelSettingsBtn = document.getElementById('cancel-settings');
    const providerSelect = document.getElementById('api-provider');
    const baseUrlGroup = document.getElementById('base-url-group');

    function loadSettings() {
        providerSelect.value = localStorage.getItem('ai_provider') || 'openai';
        document.getElementById('api-key').value = localStorage.getItem('ai_api_key') || '';
        document.getElementById('base-url').value = localStorage.getItem('ai_base_url') || '';
        document.getElementById('model-name').value = localStorage.getItem('ai_model') || 'gpt-4o';
        toggleBaseUrl();
    }

    function toggleBaseUrl() {
        baseUrlGroup.style.display = providerSelect.value === 'custom' ? 'block' : 'none';
    }

    settingsBtn.addEventListener('click', () => { modal.style.display = 'flex'; loadSettings(); });
    cancelSettingsBtn.addEventListener('click', () => { modal.style.display = 'none'; });
    providerSelect.addEventListener('change', toggleBaseUrl);

    saveSettingsBtn.addEventListener('click', () => {
        localStorage.setItem('ai_provider', providerSelect.value);
        localStorage.setItem('ai_api_key', document.getElementById('api-key').value);
        localStorage.setItem('ai_base_url', document.getElementById('base-url').value);
        localStorage.setItem('ai_model', document.getElementById('model-name').value);
        modal.style.display = 'none';
        alert("Settings saved!");
    });

    // Toggle Logic (Deprecated/Removed - handled by parent)
    /*
    const toggleBtn = document.getElementById('toggle-chat-btn');
    ...
    */

    // --- Resizing Logic (Removed) ---
    /*
    const handle = document.getElementById('resize-handle');
    ...
    */

    // Clear Chat button
    document.getElementById('clear-chat-btn').addEventListener('click', async () => {
        chatHistory = [];
        // Keep the system message, remove everything else
        chatMessages.innerHTML = '<div class="message msg-system">Select text to ask about it, or just type a question.</div>';
        await clearChatHistoryOnServer();
    });

    // --- Restore persisted sidebar width and collapsed state (Removed) ---

    // Load chat history on page load
    loadChatHistory();
</script>